{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-handshake me-2"></i>
                        Novo Empréstimo
                    </h4>
                </div>
                <div class="card-body">
                    <form id="emprestimoForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="usuario_id" class="form-label">Usuário *</label>
                                    <select class="form-select" id="usuario_id" name="usuario_id" required>
                                        <option value="">Selecione um usuário</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="livro_id" class="form-label">Livro *</label>
                                    <select class="form-select" id="livro_id" name="livro_id" required>
                                        <option value="">Selecione um livro</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="observacoes" class="form-label">Observações</label>
                            <textarea class="form-control" id="observacoes" name="observacoes" rows="3" 
                                      placeholder="Observações sobre o empréstimo (opcional)"></textarea>
                        </div>

                        <!-- Informações do empréstimo -->
                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <h6 class="card-title">Informações do Empréstimo</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <small class="text-muted">
                                            <strong>Data de Empréstimo:</strong><br>
                                            <span id="dataEmprestimo">Hoje</span>
                                        </small>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted">
                                            <strong>Data de Devolução Prevista:</strong><br>
                                            <span id="dataDevolucao">14 dias a partir de hoje</span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="/emprestimos" class="btn btn-secondary me-md-2">
                                <i class="bi bi-arrow-left me-1"></i>Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-lg me-1"></i>Criar Empréstimo
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Verificar se o usuário é admin
    verificarPermissaoAdmin();
    
    // Atualizar datas
    atualizarDatas();
    
    // Verificar parâmetros da URL
    verificarParametrosURL();
    
    // Configurar formulário
    document.getElementById('emprestimoForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        await criarEmprestimo();
    });
});

async function verificarPermissaoAdmin() {
    const token = localStorage.getItem('access_token');
    if (!token) {
        showToast('Você precisa estar logado para acessar esta página', 'error');
        setTimeout(() => {
            window.location.href = '/';
        }, 2000);
        return;
    }

    try {
        const response = await fetch('/api/v1/auth/me', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            const user = await response.json();
            if (user.is_admin) {
                carregarUsuarios();
                carregarLivrosDisponiveis();
            } else {
                showToast('Acesso negado. Apenas administradores podem criar empréstimos.', 'error');
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);
            }
        } else {
            showToast('Erro ao verificar permissões', 'error');
            setTimeout(() => {
                window.location.href = '/';
            }, 2000);
        }
    } catch (error) {
        console.error('Erro ao verificar permissões:', error);
        showToast('Erro ao conectar com o servidor', 'error');
    }
}

async function carregarUsuarios() {
    const token = localStorage.getItem('access_token');
    if (!token) return;

    try {
        const response = await fetch('/api/v1/usuarios/', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            const usuarios = await response.json();
            const select = document.getElementById('usuario_id');
            
            // Limpar opções existentes
            select.innerHTML = '<option value="">Selecione um usuário</option>';
            
            // Adicionar usuários
            usuarios.forEach(usuario => {
                const option = document.createElement('option');
                option.value = usuario.id;
                option.textContent = `${usuario.nome} (${usuario.matricula})`;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Erro ao carregar usuários:', error);
        showToast('Erro ao carregar usuários', 'error');
    }
}

async function carregarLivrosDisponiveis() {
    try {
        const response = await fetch('/api/v1/livros/');
        
        if (response.ok) {
            const livros = await response.json();
            const select = document.getElementById('livro_id');
            
            // Limpar opções existentes
            select.innerHTML = '<option value="">Selecione um livro</option>';
            
            // Filtrar apenas livros disponíveis
            const livrosDisponiveis = livros.filter(livro => 
                livro.status === 'DISPONIVEL' || 
                livro.status === 'StatusLivro.DISPONIVEL' || 
                livro.status.includes('DISPONIVEL')
            );
            
            if (livrosDisponiveis.length === 0) {
                select.innerHTML = '<option value="">Nenhum livro disponível</option>';
                return;
            }
            
            // Adicionar livros disponíveis
            livrosDisponiveis.forEach(livro => {
                const option = document.createElement('option');
                option.value = livro.id;
                option.textContent = `${livro.titulo} - ${livro.autor?.nome || 'Autor desconhecido'}`;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Erro ao carregar livros:', error);
        showToast('Erro ao carregar livros', 'error');
    }
}

function verificarParametrosURL() {
    const urlParams = new URLSearchParams(window.location.search);
    const livroId = urlParams.get('livro_id');
    const titulo = urlParams.get('titulo');
    
    if (livroId && titulo) {
        // Aguardar o carregamento dos livros e pré-selecionar
        setTimeout(() => {
            const selectLivro = document.getElementById('livro_id');
            if (selectLivro) {
                selectLivro.value = livroId;
                // Destacar que o livro foi pré-selecionado
                selectLivro.style.backgroundColor = '#e7f3ff';
                showToast(`Livro "${titulo}" pré-selecionado`, 'info');
            }
        }, 2000);
    }
}

function atualizarDatas() {
    const hoje = new Date();
    const devolucao = new Date();
    devolucao.setDate(hoje.getDate() + 14);
    
    document.getElementById('dataEmprestimo').textContent = hoje.toLocaleDateString('pt-BR');
    document.getElementById('dataDevolucao').textContent = devolucao.toLocaleDateString('pt-BR');
}

async function criarEmprestimo() {
    const token = localStorage.getItem('access_token');
    if (!token) {
        showToast('Você precisa estar logado para criar empréstimos', 'error');
        return;
    }

    const formData = new FormData(document.getElementById('emprestimoForm'));
    const emprestimoData = {};
    
    // Converter FormData para objeto
    for (let [key, value] of formData.entries()) {
        if (value && value.trim() !== '') {
            if (key === 'usuario_id' || key === 'livro_id') {
                emprestimoData[key] = parseInt(value);
            } else {
                emprestimoData[key] = value.trim();
            }
        }
    }

    // Validações obrigatórias
    if (!emprestimoData.usuario_id) {
        showToast('Selecione um usuário', 'error');
        return;
    }
    
    if (!emprestimoData.livro_id) {
        showToast('Selecione um livro', 'error');
        return;
    }

    console.log('Dados a serem enviados:', emprestimoData);

    try {
        const response = await fetch('/api/v1/emprestimos/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(emprestimoData)
        });

        if (response.ok) {
            showToast('Empréstimo criado com sucesso!', 'success');
            setTimeout(() => {
                window.location.href = '/emprestimos';
            }, 1500);
        } else if (response.status === 403) {
            showToast('Acesso negado. Apenas administradores podem criar empréstimos.', 'error');
        } else if (response.status === 422) {
            const error = await response.json();
            console.error('Erro de validação 422:', error);
            
            // Mostrar detalhes dos erros de validação
            if (error.detail && Array.isArray(error.detail)) {
                const errorMessages = error.detail.map(err => `${err.loc.join('.')}: ${err.msg}`).join('\n');
                showToast(`Erro de validação:\n${errorMessages}`, 'error');
            } else {
                showToast(error.detail || 'Erro de validação dos dados', 'error');
            }
        } else {
            const error = await response.json();
            console.error('Erro ao criar empréstimo:', error);
            showToast(error.detail || 'Erro ao criar empréstimo', 'error');
        }
    } catch (error) {
        console.error('Erro ao criar empréstimo:', error);
        showToast('Erro ao conectar com o servidor', 'error');
    }
}
</script>
{% endblock %}
