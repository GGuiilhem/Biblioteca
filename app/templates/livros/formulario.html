{% extends "base.html" %}

{% block extra_css %}
<style>
/* Customizar Select2 para parecer com Bootstrap */
.select2-container--default .select2-selection--single {
    height: 38px;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    padding: 6px 12px;
}

.select2-container--default .select2-selection--single .select2-selection__rendered {
    color: #495057;
    line-height: 26px;
}

.select2-container--default .select2-selection--single .select2-selection__arrow {
    height: 36px;
}

.select2-dropdown {
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
}

.select2-container--default .select2-search--dropdown .select2-search__field {
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
}

.select2-container--default .select2-results__option--highlighted[aria-selected] {
    background-color: #0d6efd;
}

.select2-container {
    width: 100% !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-book me-2"></i>
                        <span id="tituloFormulario">
                            {% if livro_id %}Editar Livro{% else %}Adicionar Novo Livro{% endif %}
                        </span>
                    </h4>
                </div>
                <div class="card-body">
                    <form id="livroForm">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="titulo" class="form-label">Título *</label>
                                    <input type="text" class="form-control" id="titulo" name="titulo" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="subtitulo" class="form-label">Subtítulo</label>
                                    <input type="text" class="form-control" id="subtitulo" name="subtitulo">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="autor_id" class="form-label">Autor *</label>
                                    <select class="form-select" id="autor_id" name="autor_id" required>
                                        <option value="">Selecione um autor</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editora_id" class="form-label">Editora</label>
                                    <select class="form-select" id="editora_id" name="editora_id">
                                        <option value="">Selecione uma editora</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="isbn" class="form-label">ISBN *</label>
                                    <input type="text" class="form-control" id="isbn" name="isbn" required 
                                           placeholder="9788535902777"
                                           maxlength="13"
                                           pattern="[0-9]{10,13}"
                                           oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 13)">
                                    <div class="form-text">Apenas números (10 ou 13 dígitos)</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="edicao" class="form-label">Edição</label>
                                    <input type="number" class="form-control" id="edicao" name="edicao" min="1" value="1">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="ano_publicacao" class="form-label">Ano de Publicação</label>
                                    <input type="number" class="form-control" id="ano_publicacao" name="ano_publicacao" 
                                           min="1000" max="2100">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="num_paginas" class="form-label">Número de Páginas</label>
                                    <input type="number" class="form-control" id="num_paginas" name="num_paginas" min="1">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="genero" class="form-label">Gênero</label>
                                    <input type="text" class="form-control" id="genero" name="genero" 
                                           placeholder="Romance, Ficção, etc.">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="idioma" class="form-label">Idioma</label>
                                    <input type="text" class="form-control" id="idioma" name="idioma" value="Português">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="sinopse" class="form-label">Sinopse</label>
                            <textarea class="form-control" id="sinopse" name="sinopse" rows="4" 
                                      placeholder="Breve descrição do livro..."></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="capa_url" class="form-label">URL da Capa</label>
                            <input type="url" class="form-control" id="capa_url" name="capa_url" 
                                   placeholder="https://exemplo.com/capa.jpg">
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="/livros" class="btn btn-secondary me-md-2">
                                <i class="bi bi-arrow-left me-1"></i>Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-lg me-1"></i>Salvar Livro
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Detectar se é edição pela URL
    const urlPath = window.location.pathname;
    const isEdicao = urlPath.includes('/editar');
    const livroId = isEdicao ? urlPath.split('/')[2] : null;
    
    // Verificar se o usuário é admin
    verificarPermissaoAdmin();
    
    // Carregar autores e editoras
    carregarAutores();
    carregarEditoras();
    
    // Se for edição, carregar dados do livro
    if (isEdicao && livroId) {
        carregarDadosLivro(parseInt(livroId));
    }
    
    // Configurar formulário
    document.getElementById('livroForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        await salvarLivro();
    });
});

async function verificarPermissaoAdmin() {
    const token = localStorage.getItem('access_token');
    if (!token) {
        showToast('Você precisa estar logado para acessar esta página', 'error');
        setTimeout(() => window.location.href = '/livros', 2000);
        return;
    }

    try {
        const response = await fetch('/api/v1/auth/me', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            const user = await response.json();
            if (!user.is_admin) {
                showToast('Acesso negado. Apenas administradores podem adicionar livros.', 'error');
                setTimeout(() => window.location.href = '/livros', 2000);
                return;
            }
        } else {
            showToast('Erro ao verificar permissões', 'error');
            setTimeout(() => window.location.href = '/livros', 2000);
        }
    } catch (error) {
        console.error('Erro ao verificar permissões:', error);
        showToast('Erro ao conectar com o servidor', 'error');
        setTimeout(() => window.location.href = '/livros', 2000);
    }
}


async function carregarAutores() {
    try {
        const response = await fetch('/api/v1/autores/');
        if (response.ok) {
            const autores = await response.json();
            // Construir HTML das opções e preencher select nativo
            autores.sort((a, b) => a.nome.localeCompare(b.nome));
            let optionsHTML = '<option value="">Selecione um autor</option>';
            autores.forEach(autor => {
                optionsHTML += `<option value="${autor.id}">${autor.nome}</option>`;
            });
            const select = document.getElementById('autor_id');
            select.innerHTML = optionsHTML;
        }
    } catch (error) {
        console.error('Erro ao carregar autores:', error);
    }
}

async function carregarEditoras() {
    try {
        const response = await fetch('/api/v1/editoras/');
        
        if (response.ok) {
            const editoras = await response.json();
            editoras.sort((a, b) => a.nome.localeCompare(b.nome));
            let optionsHTML = '<option value="">Selecione uma editora</option>';
            editoras.forEach(editora => {
                optionsHTML += `<option value="${editora.id}">${editora.nome}</option>`;
            });
            const select = document.getElementById('editora_id');
            select.innerHTML = optionsHTML;
        }
    } catch (error) {
        console.error('Erro ao carregar editoras:', error);
    }
}

async function carregarDadosLivro(livroId) {
    const token = localStorage.getItem('access_token');
    if (!token) return;

    try {
        const response = await fetch(`/api/v1/livros/${livroId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            const livro = await response.json();
            
            // Preencher o formulário com os dados do livro
            document.getElementById('titulo').value = livro.titulo || '';
            document.getElementById('subtitulo').value = livro.subtitulo || '';
            document.getElementById('isbn').value = livro.isbn || '';
            document.getElementById('edicao').value = livro.edicao || 1;
            document.getElementById('ano_publicacao').value = livro.ano_publicacao || '';
            document.getElementById('num_paginas').value = livro.num_paginas || '';
            document.getElementById('sinopse').value = livro.sinopse || '';
            document.getElementById('genero').value = livro.genero || '';
            document.getElementById('idioma').value = livro.idioma || 'Português';
            document.getElementById('capa_url').value = livro.capa_url || '';
            
            // Selecionar o autor e editora corretos quando forem carregados
            setTimeout(() => {
                if (livro.autor_id) {
                    const autorSelect = document.getElementById('autor_id');
                    if (autorSelect) autorSelect.value = livro.autor_id;
                }
                if (livro.editora_id) {
                    const editoraSelect = document.getElementById('editora_id');
                    if (editoraSelect) editoraSelect.value = livro.editora_id;
                }
            }, 1500); // Tempo para garantir que autores e editoras sejam carregados
            
        } else {
            showToast('Erro ao carregar dados do livro', 'error');
        }
    } catch (error) {
        console.error('Erro ao carregar livro:', error);
        showToast('Erro ao conectar com o servidor', 'error');
    }
}

async function salvarLivro() {
    const token = localStorage.getItem('access_token');
    if (!token) {
        showToast('Você precisa estar logado para adicionar livros', 'error');
        return;
    }

    const formData = new FormData(document.getElementById('livroForm'));
    const livroData = {};
    
    // Converter FormData para objeto
    for (let [key, value] of formData.entries()) {
        if (value && value.trim() !== '') {
            // Converter números
            if (['autor_id', 'editora_id', 'edicao', 'ano_publicacao', 'num_paginas'].includes(key)) {
                const numValue = parseInt(value);
                if (!isNaN(numValue) && numValue > 0) {
                    livroData[key] = numValue;
                }
            } else {
                livroData[key] = value;
            }
        }
    }

    // Validações obrigatórias
    if (!livroData.titulo) {
        showToast('O título é obrigatório', 'error');
        return;
    }
    
    if (!livroData.autor_id) {
        showToast('Selecione um autor', 'error');
        return;
    }
    
    if (!livroData.isbn) {
        showToast('O ISBN é obrigatório', 'error');
        return;
    }

    // Validar formato do ISBN (já deve conter apenas números devido ao filtro do input)
    if (livroData.isbn.length !== 10 && livroData.isbn.length !== 13) {
        showToast(`ISBN deve ter 10 ou 13 dígitos. Você digitou ${livroData.isbn.length} dígitos.`, 'error');
        return;
    }

    // Garantir que campos com valores padrão sejam enviados
    if (!livroData.idioma) {
        livroData.idioma = "Português";
    }
    
    if (!livroData.edicao) {
        livroData.edicao = 1;
    }

    console.log('Dados a serem enviados:', livroData);

    // Detectar se é edição
    const urlPath = window.location.pathname;
    const isEdicao = urlPath.includes('/editar');
    const livroId = isEdicao ? urlPath.split('/')[2] : null;

    try {
        const url = isEdicao ? `/api/v1/livros/${livroId}` : '/api/v1/livros/';
        const method = isEdicao ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(livroData)
        });

        if (response.ok) {
            const mensagem = isEdicao ? 'Livro atualizado com sucesso!' : 'Livro adicionado com sucesso!';
            showToast(mensagem, 'success');
            setTimeout(() => {
                window.location.href = '/livros';
            }, 1500);
        } else if (response.status === 403) {
            const acao = isEdicao ? 'editar' : 'adicionar';
            showToast(`Acesso negado. Apenas administradores podem ${acao} livros.`, 'error');
        } else if (response.status === 422) {
            const error = await response.json();
            console.error('Erro de validação 422:', error);
            
            // Mostrar detalhes dos erros de validação
            if (error.detail && Array.isArray(error.detail)) {
                const errorMessages = error.detail.map(err => `${err.loc.join('.')}: ${err.msg}`).join('\n');
                showToast(`Erro de validação:\n${errorMessages}`, 'error');
            } else {
                showToast(error.detail || 'Erro de validação dos dados', 'error');
            }
        } else {
            const error = await response.json();
            console.error('Erro ao adicionar livro:', error);
            showToast(error.detail || 'Erro ao adicionar livro', 'error');
        }
    } catch (error) {
        console.error('Erro ao salvar livro:', error);
        showToast('Erro ao conectar com o servidor', 'error');
    }
}

function configurarSelect2() {
    // função vazia: Select2 removido, mantemos a função para compatibilidade
    return;
}
</script>
{% endblock %}
