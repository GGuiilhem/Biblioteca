{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h2 class="mb-0">{% if autor_id %}Editar Autor{% else %}Novo Autor{% endif %}</h2>
                </div>
                <div class="card-body">
                    <form id="formAutor">
                        <input type="hidden" id="autorId" value="{{ autor_id or '' }}">
                        
                        <div class="mb-3">
                            <label for="nome" class="form-label">Nome *</label>
                            <input type="text" class="form-control" id="nome" required>
                            <div class="invalid-feedback">Por favor, informe o nome do autor.</div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="nacionalidade" class="form-label">Nacionalidade</label>
                                <input type="text" class="form-control" id="nacionalidade">
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="dataNascimento" class="form-label">Data de Nascimento</label>
                                <input type="date" class="form-control" id="dataNascimento">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="biografia" class="form-label">Biografia</label>
                            <textarea class="form-control" id="biografia" rows="4"></textarea>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="/autores" class="btn btn-secondary me-md-2">
                                <i class="bi bi-arrow-left"></i> Voltar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> {% if autor_id %}Atualizar{% else %}Salvar{% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('formAutor');
        const autorIdElement = document.getElementById('autorId');
        
        if (!form) {
            console.error('Formulário não encontrado!');
            return;
        }
        
        const autorId = autorIdElement ? autorIdElement.value : null;
        
        // Se estiver editando, carrega os dados do autor
        if (autorId) {
            carregarAutor(autorId);
        }
        
        // Validação do formulário
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!form.checkValidity()) {
                e.stopPropagation();
                form.classList.add('was-validated');
                return;
            }
            
            const nomeElement = document.getElementById('nome');
            const nacionalidadeElement = document.getElementById('nacionalidade');
            const dataNascimentoElement = document.getElementById('dataNascimento');
            const biografiaElement = document.getElementById('biografia');
            
            if (!nomeElement) {
                console.error('Campo nome não encontrado!');
                return;
            }
            
            const autorData = {
                nome: nomeElement.value,
                nacionalidade: nacionalidadeElement ? nacionalidadeElement.value || null : null,
                data_nascimento: dataNascimentoElement ? dataNascimentoElement.value || null : null,
                biografia: biografiaElement ? biografiaElement.value || null : null
            };
            
            // Salvar o autor via API
            console.log('Dados do autor:', autorData);
            await salvarAutor(autorData, autorId);
        });
        
        async function salvarAutor(autorData, autorId) {
            const token = localStorage.getItem('access_token');
            if (!token) {
                showToast('Você precisa estar logado para salvar autores', 'error');
                return;
            }

            const isEdicao = autorId && autorId.trim() !== '';
            const url = isEdicao ? `/api/v1/autores/${autorId}` : '/api/v1/autores/';
            const method = isEdicao ? 'PUT' : 'POST';
            const mensagemSucesso = isEdicao ? 'Autor atualizado com sucesso!' : 'Autor criado com sucesso!';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(autorData)
                });

                if (response.ok) {
                    const autor = await response.json();
                    showToast(mensagemSucesso, 'success');
                    setTimeout(() => {
                        window.location.href = '/autores';
                    }, 1500);
                } else {
                    const error = await response.json();
                    showToast(error.detail || 'Erro ao salvar autor', 'error');
                }
            } catch (error) {
                console.error('Erro ao salvar autor:', error);
                showToast('Erro ao conectar com o servidor', 'error');
            }
        }
        
        async function carregarAutor(id) {
            console.log(`Carregando autor com ID: ${id}`);
            
            try {
                const response = await fetch(`/api/v1/autores/${id}`);
                
                if (response.ok) {
                    const autor = await response.json();
                    console.log('Dados do autor carregados:', autor);
                    
                    // Preencher os campos com os dados reais
                    const nomeElement = document.getElementById('nome');
                    const nacionalidadeElement = document.getElementById('nacionalidade');
                    const dataNascimentoElement = document.getElementById('dataNascimento');
                    const biografiaElement = document.getElementById('biografia');
                    
                    if (nomeElement) nomeElement.value = autor.nome || '';
                    if (nacionalidadeElement) nacionalidadeElement.value = autor.nacionalidade || '';
                    if (dataNascimentoElement) dataNascimentoElement.value = autor.data_nascimento || '';
                    if (biografiaElement) biografiaElement.value = autor.biografia || '';
                    
                } else {
                    console.error('Erro ao carregar autor:', response.status);
                    showToast('Erro ao carregar dados do autor', 'error');
                }
            } catch (error) {
                console.error('Erro ao carregar autor:', error);
                showToast('Erro ao conectar com o servidor', 'error');
            }
        }
    });
</script>
{% endblock %}
