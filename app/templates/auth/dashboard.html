{% extends "base.html" %}

{% block title %}Dashboard - Biblioteca IMPACTA{% endblock %}

{% block content %}
<!-- Tela de carregamento -->
<div id="loadingScreen" class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-6 text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-3">Verificando permissões...</p>
        </div>
    </div>
</div>

<!-- Tela de acesso negado -->
<div id="accessDenied" class="container mt-4" style="display: none;">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="alert alert-danger text-center">
                <i class="bi bi-shield-exclamation fs-1 mb-3"></i>
                <h4>Acesso Negado</h4>
                <p>Esta página é restrita apenas para administradores.</p>
                <p>Entre em contato com um administrador se você acredita que deveria ter acesso.</p>
                <a href="/" class="btn btn-primary mt-3">
                    <i class="bi bi-house me-2"></i>Voltar ao Início
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Conteúdo do dashboard (só aparece para admins) -->
<div id="dashboardContent" class="container mt-4" style="display: none;">
    <!-- Header do Dashboard -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h2>
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user me-1"></i>Minha Conta
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#"><i class="fas fa-user-edit me-2"></i>Perfil</a></li>
                        <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i>Configurações</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/api/v1/auth/logout-form"><i class="fas fa-sign-out-alt me-2"></i>Sair</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Cards de Estatísticas -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">1,234</h4>
                            <p class="card-text">Total de Livros</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-book fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">156</h4>
                            <p class="card-text">Empréstimos Ativos</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-hand-holding fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">23</h4>
                            <p class="card-text">Empréstimos Atrasados</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">89</h4>
                            <p class="card-text">Usuários Ativos</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ações Rápidas -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-bolt me-2"></i>Ações Rápidas</h5>
                </div>
                <div class="card-body">
                    <div class="row justify-content-center">
                        <div class="col-md-2 col-sm-4 col-6 mb-3">
                            <a href="/livros/novo" class="btn btn-outline-primary w-100">
                                <i class="fas fa-plus-circle d-block mb-2"></i>
                                Novo Livro
                            </a>
                        </div>
                        <div class="col-md-2 col-sm-4 col-6 mb-3">
                            <a href="/autores/novo" class="btn btn-outline-success w-100">
                                <i class="fas fa-user-plus d-block mb-2"></i>
                                Novo Autor
                            </a>
                        </div>
                        <div class="col-md-2 col-sm-4 col-6 mb-3">
                            <a href="/emprestimos" class="btn btn-outline-warning w-100">
                                <i class="fas fa-handshake d-block mb-2"></i>
                                Empréstimos
                            </a>
                        </div>
                        <div class="col-md-2 col-sm-4 col-6 mb-3">
                            <a href="/relatorios" class="btn btn-outline-secondary w-100">
                                <i class="fas fa-chart-bar d-block mb-2"></i>
                                Relatórios
                            </a>
                        </div>
                        <div class="col-md-2 col-sm-4 col-6 mb-3">
                            <button onclick="abrirSolicitacoes()" class="btn btn-outline-warning w-100">
                                <i class="fas fa-user-check d-block mb-2"></i>
                                Solicitações
                                <span id="badgeSolicitacoes" class="badge bg-danger ms-1" style="display: none;">0</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Empréstimos Recentes e Livros Populares -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-clock me-2"></i>Empréstimos Recentes</h5>
                </div>
                <div class="card-body">
                    <div id="emprestimosRecentes" class="list-group list-group-flush">
                        <div class="list-group-item text-center">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <span class="ms-2">Carregando empréstimos...</span>
                        </div>
                    </div>
                    <div class="text-center mt-3">
                        <a href="/emprestimos" class="btn btn-sm btn-outline-primary">Ver todos</a>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-star me-2"></i>Livros Mais Populares</h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">Clean Code</h6>
                                <small class="text-muted">Robert C. Martin</small>
                            </div>
                            <span class="badge bg-primary rounded-pill">23 empréstimos</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">Dom Casmurro</h6>
                                <small class="text-muted">Machado de Assis</small>
                            </div>
                            <span class="badge bg-primary rounded-pill">18 empréstimos</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">Domain-Driven Design</h6>
                                <small class="text-muted">Eric Evans</small>
                            </div>
                            <span class="badge bg-primary rounded-pill">15 empréstimos</span>
                        </div>
                    </div>
                    <div class="text-center mt-3">
                        <a href="/livros" class="btn btn-sm btn-outline-primary">Ver todos</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Solicitações de Autores -->
<div class="modal fade" id="modalSolicitacoes" tabindex="-1" aria-labelledby="modalSolicitacoesLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalSolicitacoesLabel">
                    <i class="fas fa-user-check me-2"></i>Solicitações de Autores Pendentes
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="loadingSolicitacoes" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2">Carregando solicitações...</p>
                </div>
                
                <div id="listaSolicitacoes" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Nome do Autor</th>
                                    <th>Nacionalidade</th>
                                    <th>Solicitante</th>
                                    <th>Data</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="tbodySolicitacoes">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="semSolicitacoes" class="text-center" style="display: none;">
                    <i class="fas fa-check-circle text-success fa-3x mb-3"></i>
                    <h5>Nenhuma solicitação pendente</h5>
                    <p class="text-muted">Todas as solicitações foram processadas.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Detalhes da Solicitação -->
<div class="modal fade" id="modalDetalhes" tabindex="-1" aria-labelledby="modalDetalhesLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalDetalhesLabel">Detalhes da Solicitação</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="conteudoDetalhes">
                <!-- Conteúdo será preenchido via JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-danger" onclick="rejeitarSolicitacao()">
                    <i class="fas fa-times me-1"></i>Rejeitar
                </button>
                <button type="button" class="btn btn-success" onclick="aprovarSolicitacao()">
                    <i class="fas fa-check me-1"></i>Aprovar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    verificarPermissaoAdmin();
});

async function verificarPermissaoAdmin() {
    const token = localStorage.getItem('access_token');
    
    if (!token) {
        mostrarAcessoNegado();
        return;
    }

    try {
        const response = await fetch('/api/v1/auth/me', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            const user = await response.json();
            if (user.is_admin) {
                mostrarDashboard();
                carregarEstatisticas();
            } else {
                mostrarAcessoNegado();
            }
        } else {
            mostrarAcessoNegado();
        }
    } catch (error) {
        console.error('Erro ao verificar permissões:', error);
        mostrarAcessoNegado();
    }
}

function mostrarDashboard() {
    document.getElementById('loadingScreen').style.display = 'none';
    document.getElementById('accessDenied').style.display = 'none';
    document.getElementById('dashboardContent').style.display = 'block';
}

function mostrarAcessoNegado() {
    document.getElementById('loadingScreen').style.display = 'none';
    document.getElementById('dashboardContent').style.display = 'none';
    document.getElementById('accessDenied').style.display = 'block';
}

async function carregarEstatisticas() {
    console.log('Carregando estatísticas do dashboard...');
    
    // Carregar dados reais do banco
    await Promise.all([
        carregarContadorLivros(),
        carregarContadorUsuarios(),
        carregarEmprestimosRecentes(),
        carregarLivrosPopulares(),
        carregarContadorSolicitacoes(),
        carregarEmprestimosRecentes()
    ]);
}

async function carregarContadorLivros() {
    try {
        const response = await fetch('/api/v1/livros/');
        if (response.ok) {
            const livros = await response.json();
            document.querySelector('.card.bg-primary .card-title').textContent = livros.length.toLocaleString();
        }
    } catch (error) {
        console.error('Erro ao carregar contador de livros:', error);
    }
}

async function carregarContadorUsuarios() {
    const token = localStorage.getItem('access_token');
    try {
        const response = await fetch('/api/v1/usuarios/', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        if (response.ok) {
            const usuarios = await response.json();
            document.querySelector('.card.bg-info .card-title').textContent = usuarios.length.toLocaleString();
        }
    } catch (error) {
        console.error('Erro ao carregar contador de usuários:', error);
    }
}

async function carregarEmprestimosRecentes() {
    // Por enquanto, mantemos dados estáticos para empréstimos
    // Quando implementar o sistema de empréstimos, substituir por dados reais
    console.log('Empréstimos: dados estáticos (implementar quando criar sistema de empréstimos)');
}

async function carregarLivrosPopulares() {
    try {
        const response = await fetch('/api/v1/livros/');
        if (response.ok) {
            const livros = await response.json();
            const container = document.querySelector('.card:has(.fa-star) .list-group');
            
            if (livros.length === 0) {
                container.innerHTML = '<div class="list-group-item text-center text-muted">Nenhum livro cadastrado</div>';
                return;
            }
            
            // Pegar os primeiros 3 livros como "populares" (ordenar por ID decrescente para pegar os mais recentes)
            const livrosRecentes = livros.slice(-3).reverse();
            
            container.innerHTML = '';
            livrosRecentes.forEach((livro, index) => {
                const item = document.createElement('div');
                item.className = 'list-group-item d-flex justify-content-between align-items-center';
                item.innerHTML = `
                    <div>
                        <h6 class="mb-1">${livro.titulo}</h6>
                        <small class="text-muted">${livro.autor ? livro.autor.nome : 'Autor não informado'}</small>
                    </div>
                    <span class="badge bg-primary rounded-pill">${Math.floor(Math.random() * 20) + 5} empréstimos</span>
                `;
                container.appendChild(item);
            });
            
            // Adicionar botão "Ver todos"
            const btnContainer = document.querySelector('.card:has(.fa-star) .text-center');
            if (btnContainer) {
                btnContainer.innerHTML = '<a href="/livros" class="btn btn-sm btn-outline-primary">Ver todos</a>';
            }
        }
    } catch (error) {
        console.error('Erro ao carregar livros populares:', error);
    }
}

let solicitacaoAtual = null;

async function carregarContadorSolicitacoes() {
    const token = localStorage.getItem('access_token');
    try {
        const response = await fetch('/api/v1/solicitacoes-autores/?status_filtro=pendente', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            const solicitacoes = await response.json();
            const badge = document.getElementById('badgeSolicitacoes');
            if (solicitacoes.length > 0) {
                badge.textContent = solicitacoes.length;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }
        }
    } catch (error) {
        console.error('Erro ao carregar contador de solicitações:', error);
    }
}

async function abrirSolicitacoes() {
    const modal = new bootstrap.Modal(document.getElementById('modalSolicitacoes'));
    modal.show();
    await carregarSolicitacoes();
}

async function carregarSolicitacoes() {
    const token = localStorage.getItem('access_token');
    
    // Mostrar loading
    document.getElementById('loadingSolicitacoes').style.display = 'block';
    document.getElementById('listaSolicitacoes').style.display = 'none';
    document.getElementById('semSolicitacoes').style.display = 'none';
    
    try {
        const response = await fetch('/api/v1/solicitacoes-autores/?status_filtro=pendente', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            const solicitacoes = await response.json();
            
            document.getElementById('loadingSolicitacoes').style.display = 'none';
            
            if (solicitacoes.length === 0) {
                document.getElementById('semSolicitacoes').style.display = 'block';
                return;
            }
            
            const tbody = document.getElementById('tbodySolicitacoes');
            tbody.innerHTML = '';
            
            solicitacoes.forEach(solicitacao => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${solicitacao.id}</td>
                    <td><strong>${solicitacao.nome}</strong></td>
                    <td>${solicitacao.nacionalidade || 'N/A'}</td>
                    <td>${solicitacao.solicitante_nome}</td>
                    <td>${new Date(solicitacao.data_solicitacao).toLocaleDateString('pt-BR')}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="verDetalhes(${solicitacao.id})">
                            <i class="fas fa-eye"></i> Ver
                        </button>
                        <button class="btn btn-sm btn-success me-1" onclick="aprovarRapido(${solicitacao.id})">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="rejeitarRapido(${solicitacao.id})">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            document.getElementById('listaSolicitacoes').style.display = 'block';
        }
    } catch (error) {
        console.error('Erro ao carregar solicitações:', error);
        document.getElementById('loadingSolicitacoes').style.display = 'none';
        showToast('Erro ao carregar solicitações', 'error');
    }
}

async function verDetalhes(solicitacaoId) {
    const token = localStorage.getItem('access_token');
    
    try {
        const response = await fetch(`/api/v1/solicitacoes-autores/${solicitacaoId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            const solicitacao = await response.json();
            solicitacaoAtual = solicitacao;
            
            const conteudo = document.getElementById('conteudoDetalhes');
            conteudo.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Informações do Autor</h6>
                        <p><strong>Nome:</strong> ${solicitacao.nome}</p>
                        <p><strong>Nacionalidade:</strong> ${solicitacao.nacionalidade || 'N/A'}</p>
                        <p><strong>Data de Nascimento:</strong> ${solicitacao.data_nascimento ? new Date(solicitacao.data_nascimento).toLocaleDateString('pt-BR') : 'N/A'}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Informações da Solicitação</h6>
                        <p><strong>Solicitante:</strong> ${solicitacao.solicitante_nome}</p>
                        <p><strong>Data da Solicitação:</strong> ${new Date(solicitacao.data_solicitacao).toLocaleDateString('pt-BR')}</p>
                        <p><strong>Status:</strong> <span class="badge bg-warning">Pendente</span></p>
                    </div>
                </div>
                ${solicitacao.biografia ? `
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Biografia</h6>
                            <p class="text-muted">${solicitacao.biografia}</p>
                        </div>
                    </div>
                ` : ''}
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('modalDetalhes'));
            modal.show();
        }
    } catch (error) {
        console.error('Erro ao carregar detalhes:', error);
        showToast('Erro ao carregar detalhes da solicitação', 'error');
    }
}

async function aprovarSolicitacao() {
    if (!solicitacaoAtual) return;
    
    const token = localStorage.getItem('access_token');
    
    try {
        const response = await fetch(`/api/v1/solicitacoes-autores/${solicitacaoAtual.id}/aprovar`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            showToast('Solicitação aprovada com sucesso!', 'success');
            
            // Fechar modal de detalhes
            const modalDetalhes = bootstrap.Modal.getInstance(document.getElementById('modalDetalhes'));
            modalDetalhes.hide();
            
            // Recarregar lista
            await carregarSolicitacoes();
            await carregarContadorSolicitacoes();
        } else {
            const error = await response.json();
            showToast(error.detail || 'Erro ao aprovar solicitação', 'error');
        }
    } catch (error) {
        console.error('Erro ao aprovar solicitação:', error);
        showToast('Erro ao conectar com o servidor', 'error');
    }
}

async function rejeitarSolicitacao() {
    if (!solicitacaoAtual) return;
    
    const observacoes = prompt('Digite o motivo da rejeição (opcional):');
    if (observacoes === null) return; // Usuário cancelou
    
    const token = localStorage.getItem('access_token');
    
    try {
        const response = await fetch(`/api/v1/solicitacoes-autores/${solicitacaoAtual.id}/rejeitar?observacoes=${encodeURIComponent(observacoes || 'Sem observações')}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            showToast('Solicitação rejeitada', 'info');
            
            // Fechar modal de detalhes
            const modalDetalhes = bootstrap.Modal.getInstance(document.getElementById('modalDetalhes'));
            modalDetalhes.hide();
            
            // Recarregar lista
            await carregarSolicitacoes();
            await carregarContadorSolicitacoes();
        } else {
            const error = await response.json();
            showToast(error.detail || 'Erro ao rejeitar solicitação', 'error');
        }
    } catch (error) {
        console.error('Erro ao rejeitar solicitação:', error);
        showToast('Erro ao conectar com o servidor', 'error');
    }
}

async function aprovarRapido(solicitacaoId) {
    if (!confirm('Tem certeza que deseja aprovar esta solicitação?')) return;
    
    const token = localStorage.getItem('access_token');
    
    try {
        const response = await fetch(`/api/v1/solicitacoes-autores/${solicitacaoId}/aprovar`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            showToast('Solicitação aprovada com sucesso!', 'success');
            await carregarSolicitacoes();
            await carregarContadorSolicitacoes();
        } else {
            const error = await response.json();
            showToast(error.detail || 'Erro ao aprovar solicitação', 'error');
        }
    } catch (error) {
        console.error('Erro ao aprovar solicitação:', error);
        showToast('Erro ao conectar com o servidor', 'error');
    }
}

async function rejeitarRapido(solicitacaoId) {
    const observacoes = prompt('Digite o motivo da rejeição:');
    if (!observacoes) return;
    
    const token = localStorage.getItem('access_token');
    
    try {
        const response = await fetch(`/api/v1/solicitacoes-autores/${solicitacaoId}/rejeitar?observacoes=${encodeURIComponent(observacoes)}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            showToast('Solicitação rejeitada', 'info');
            await carregarSolicitacoes();
            await carregarContadorSolicitacoes();
        } else {
            const error = await response.json();
            showToast(error.detail || 'Erro ao rejeitar solicitação', 'error');
        }
    } catch (error) {
        console.error('Erro ao rejeitar solicitação:', error);
        showToast('Erro ao conectar com o servidor', 'error');
    }
}

async function carregarEmprestimosRecentes() {
    const token = localStorage.getItem('access_token');
    if (!token) return;

    try {
        const response = await fetch('/api/v1/emprestimos/', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            const emprestimos = await response.json();
            const container = document.getElementById('emprestimosRecentes');
            
            // Filtrar apenas empréstimos ativos e pegar os 3 mais recentes
            const emprestimosAtivos = emprestimos
                .filter(emp => emp.status === 'ativo')
                .sort((a, b) => new Date(b.data_emprestimo) - new Date(a.data_emprestimo))
                .slice(0, 3);
            
            if (emprestimosAtivos.length === 0) {
                container.innerHTML = `
                    <div class="list-group-item text-center text-muted">
                        <i class="bi bi-info-circle me-2"></i>
                        Nenhum empréstimo ativo encontrado
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            emprestimosAtivos.forEach(emprestimo => {
                // Verificar se está atrasado
                const hoje = new Date();
                const devolucaoPrevista = new Date(emprestimo.data_devolucao_prevista);
                const isAtrasado = hoje > devolucaoPrevista;
                
                // Calcular tempo relativo
                const dataEmprestimo = new Date(emprestimo.data_emprestimo);
                const diffTime = Math.abs(hoje - dataEmprestimo);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                let tempoTexto = '';
                if (diffDays === 0) {
                    tempoTexto = 'Hoje';
                } else if (diffDays === 1) {
                    tempoTexto = 'Ontem';
                } else {
                    tempoTexto = `${diffDays} dias atrás`;
                }
                
                const badgeClass = isAtrasado ? 'bg-danger' : 'bg-success';
                const badgeText = isAtrasado ? 'Atrasado' : 'Ativo';
                
                const item = document.createElement('div');
                item.className = 'list-group-item d-flex justify-content-between align-items-center';
                item.innerHTML = `
                    <div>
                        <h6 class="mb-1">${emprestimo.livro_titulo || 'Título não disponível'}</h6>
                        <small class="text-muted">${emprestimo.usuario_nome || 'Usuário não disponível'} - ${tempoTexto}</small>
                    </div>
                    <span class="badge ${badgeClass} rounded-pill">${badgeText}</span>
                `;
                container.appendChild(item);
            });
            
        } else {
            console.error('Erro ao carregar empréstimos:', response.status);
            const container = document.getElementById('emprestimosRecentes');
            container.innerHTML = `
                <div class="list-group-item text-center text-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Erro ao carregar empréstimos
                </div>
            `;
        }
    } catch (error) {
        console.error('Erro ao carregar empréstimos recentes:', error);
        const container = document.getElementById('emprestimosRecentes');
        container.innerHTML = `
            <div class="list-group-item text-center text-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Erro ao conectar com o servidor
            </div>
        `;
    }
}
</script>
{% endblock %}
